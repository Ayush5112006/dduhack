generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  name                    String
  password                String
  phone                   String?
  role                    String             @default("participant")
  status                  String             @default("active")
  avatar                  String?
  bio                     String?
  otp                     String?
  otpExpiresAt            DateTime?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  emailVerified           Boolean            @default(false)
  certificates            Certificate[]
  hackathonsOwned         Hackathon[]        @relation("OwnedHackathons")
  judgeAssignments        JudgeAssignment[]
  mentorAssignments       MentorAssignment[] @relation("MentorAssignments")
  studentMentorAssignments MentorAssignment[] @relation("StudentMentorAssignments")
  notifications           Notification[]
  registrations           Registration[]
  scores                  Score[]
  sessions                Session[]
  submissions             Submission[]
  teamLeads               Team[]             @relation("TeamLeader")
  teamMembers             TeamMember[]
  profile                 UserProfile?
}

model Session {
  id                 String   @id @default(cuid())
  userId             String
  token              String   @unique
  csrfToken          String?  // CSRF token for form submissions
  fingerprint        String?  // Device fingerprint for hijacking detection
  userAgent          String?
  ipAddress          String?
  createdAt          DateTime @default(now())
  expiresAt          DateTime // Relative expiration (1 hour)
  absoluteExpiresAt  DateTime? // Absolute expiration (24 hours max)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([absoluteExpiresAt])
}

model UserProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  bio              String?
  location         String?
  website          String?
  github           String?
  linkedin         String?
  twitter          String?
  skills           String?
  interests        String?
  avatar           String?
  totalHackathons  Int      @default(0)
  totalSubmissions Int      @default(0)
  wins             Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Hackathon {
  id                   String             @id @default(cuid())
  title                String
  organizer            String
  ownerId              String
  organizationType     String?            // Company / College / Community
  organizationLogo     String?            // Logo URL
  banner               String?
  description          String?
  eligibility          String?
  problemStatementPdf  String?
  prize                String?
  prizeAmount          Int                @default(0)
  mode                 String
  location             String?
  category             String
  tags                 String?
  difficulty           String
  registrationDeadline DateTime
  startDate            DateTime
  endDate              DateTime
  status               String             @default("upcoming")
  isFree               Boolean            @default(true)
  featured             Boolean            @default(false)
  participants         Int                @default(0)
  allowTeams           Boolean            @default(true)
  minTeamSize          Int                @default(2)
  maxTeamSize          Int                @default(5)
  allowSoloSubmission  Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  certificates         Certificate[]
  owner                User               @relation("OwnedHackathons", fields: [ownerId], references: [id])
  judgeAssignments     JudgeAssignment[]
  mentorAssignments    MentorAssignment[]
  problemStatements    ProblemStatement[]
  registrations        Registration[]
  scores               Score[]
  submissions          Submission[]
  teams                Team[]
  winners              Winner[]
}

model Registration {
  id               String    @id @default(cuid())
  hackathonId      String
  userId           String
  userEmail        String
  mode             String
  teamId           String?
  status           String    @default("pending")
  consent          Boolean   @default(false)
  fullName         String?
  phone            String?
  university       String?
  enrollmentNumber String?
  branch           String?
  year             String?
  skills           String?
  experience       String?
  githubProfile    String?
  linkedinProfile  String?
  portfolioUrl     String?
  projectIdea      String?
  motivation       String?
  formData         String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  hackathon        Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  team             Team?     @relation(fields: [teamId], references: [id])
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([hackathonId, userId])
}

model Team {
  id            String         @id @default(cuid())
  hackathonId   String
  name          String
  code          String         @unique
  leaderId      String
  leaderEmail   String
  locked        Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  registrations Registration[]
  submissions   Submission[]
  hackathon     Hackathon      @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  leader        User           @relation("TeamLeader", fields: [leaderId], references: [id])
  members       TeamMember[]
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  email     String
  status    String
  role      String   @default("member")
  createdAt DateTime @default(now())
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

model ProblemStatement {
  id          String       @id @default(cuid())
  hackathonId String
  title       String
  description String?
  difficulty  String
  prize       String?
  resources   String?
  dataset     String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  hackathon   Hackathon    @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  submissions Submission[]
}

model Submission {
  id               String            @id @default(cuid())
  hackathonId      String
  teamId           String?
  userId           String?
  userEmail        String?
  psId             String?
  title            String
  description      String?
  github           String?
  demo             String?
  video            String?
  files            String?
  techStack        String?
  status           String            @default("draft")
  locked           Boolean           @default(false)
  lockedAt         DateTime?
  lockedReason     String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  certificates     Certificate[]
  scores           Score[]
  hackathon        Hackathon         @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  problemStatement ProblemStatement? @relation(fields: [psId], references: [id])
  team             Team?             @relation(fields: [teamId], references: [id])
  user             User?             @relation(fields: [userId], references: [id])
  winners          Winner[]
}

model JudgeAssignment {
  id          String    @id @default(cuid())
  hackathonId String
  judgeId     String
  judgeEmail  String
  createdAt   DateTime  @default(now())
  hackathon   Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  judge       User      @relation(fields: [judgeId], references: [id], onDelete: Cascade)

  @@unique([hackathonId, judgeId])
}

model Score {
  id           String     @id @default(cuid())
  submissionId String
  judgeId      String
  hackathonId  String
  innovation   Int
  technical    Int
  design       Int
  impact       Int
  presentation Int
  total        Float
  feedback     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  hackathon    Hackathon  @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  judge        User       @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, judgeId])
}

model Winner {
  id           String     @id @default(cuid())
  hackathonId  String
  submissionId String
  rank         Int
  prize        String?
  announcedAt  DateTime   @default(now())
  hackathon    Hackathon  @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([hackathonId, submissionId])
  @@unique([hackathonId, rank])
}

model Certificate {
  id               String      @id @default(cuid())
  userId           String
  userName         String
  userEmail        String
  hackathonId      String
  hackathonTitle   String
  fileUrl          String?
  submissionId     String?
  type             String
  rank             Int?
  verificationCode String      @unique
  verified         Boolean     @default(false)
  issuedAt         DateTime    @default(now())
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  hackathon        Hackathon   @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  submission       Submission? @relation(fields: [submissionId], references: [id])
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([hackathonId, userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model EmailOTP {
  id        String   @id @default(cuid())
  email     String   @unique
  otp       String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([email, expiresAt])
}

model MentorAssignment {
  id          String    @id @default(cuid())
  hackathonId String
  studentId   String
  mentorId    String
  assignedAt  DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  hackathon   Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  student     User      @relation("StudentMentorAssignments", fields: [studentId], references: [id], onDelete: Cascade)
  mentor      User      @relation("MentorAssignments", fields: [mentorId], references: [id], onDelete: Cascade)

  @@unique([hackathonId, studentId])
  @@index([hackathonId])
  @@index([studentId])
  @@index([mentorId])
}
